# å®¡è®¡æ—¥å¿—ç³»ç»Ÿæ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç™¾ä¸‡æ™ºèƒ½ä½“ç¤¾äº¤ç½‘ç»œæ¨¡æ‹Ÿå¹³å°çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿå®ç°ï¼ŒåŒ…æ‹¬å…¨é¢çš„å®¡è®¡åŠŸèƒ½ã€é«˜æ€§èƒ½æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µã€‚å®¡è®¡æ—¥å¿—ç³»ç»Ÿæ˜¯å®‰å…¨åŸºç¡€è®¾æ–½çš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›å®Œæ•´çš„äº‹ä»¶è¿½è¸ªã€åˆè§„ç›‘æ§å’Œå®‰å…¨åˆ†æèƒ½åŠ›ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **æ™ºèƒ½äº‹ä»¶åˆ†ç±»**: è‡ªåŠ¨è¯†åˆ«å’Œåˆ†ç±»å®‰å…¨äº‹ä»¶
- **é«˜æ€§èƒ½å¤„ç†**: æ”¯æŒç™¾ä¸‡çº§å¹¶å‘äº‹ä»¶è®°å½•
- **å¤šç»´åº¦æœç´¢**: çµæ´»çš„è¿‡æ»¤å’ŒæŸ¥è¯¢åŠŸèƒ½
- **å®æ—¶ç»Ÿè®¡**: å¸¦ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯åˆ†æ
- **æ•°æ®å¯¼å‡º**: æ”¯æŒJSON/CSVæ ¼å¼å¯¼å‡º
- **ç³»ç»Ÿé›†æˆ**: ä¸RBACã€JWTã€åŠ å¯†æ¨¡å—æ— ç¼é›†æˆ

### ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨é”æœºåˆ¶ä¿è¯å¹¶å‘å®‰å…¨
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½å†…å­˜é™åˆ¶å’Œæ¸…ç†ç­–ç•¥
- **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„æ•°æ®ç»“æ„å’Œç®—æ³•
- **å¯æ‰©å±•**: æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- **TDDå¼€å‘**: 100%æµ‹è¯•è¦†ç›–ç‡çš„å¯é ä»£ç 

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
```python
from src.security.audit_log import (
    AuditLogManager, AuditEvent, AuditSeverity,
    create_audit_event, log_security_event
)

# åˆ›å»ºå®¡è®¡æ—¥å¿—ç®¡ç†å™¨
manager = AuditLogManager(max_memory_events=10000)

# è®°å½•ç”¨æˆ·ç™»å½•äº‹ä»¶
event = create_audit_event(
    user_id="user_001",
    action="login",
    resource="auth",
    severity=AuditSeverity.INFO,
    ip_address="192.168.1.100"
)
manager.log_event(event, status="success", message="User login successful")

# è®°å½•å®‰å…¨äº‹ä»¶
log_security_event(
    manager,
    user_id="user_002",
    action="unauthorized_access",
    resource="sensitive_data",
    severity=AuditSeverity.HIGH,
    ip_address="10.0.0.1"
)
```

### æœç´¢å’Œç»Ÿè®¡ç¤ºä¾‹
```python
from src.security.audit_log import AuditSearchFilter
from datetime import datetime, timezone

# æœç´¢ç‰¹å®šç”¨æˆ·çš„é«˜é£é™©äº‹ä»¶
filter_criteria = AuditSearchFilter(
    user_ids=["user_001"],
    severities=[AuditSeverity.HIGH, AuditSeverity.CRITICAL],
    start_time=datetime.now(timezone.utc).replace(hour=0, minute=0, second=0)
)

high_risk_events = manager.search_events(filter_criteria)

# è·å–å®¡è®¡ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_audit_statistics()
print(f"æ€»äº‹ä»¶æ•°: {stats.total_events}")
print(f"é«˜é£é™©äº‹ä»¶: {stats.critical_events + stats.high_events}")
print(f"ç‹¬ç«‹ç”¨æˆ·æ•°: {stats.unique_users}")
```

### å¯¼å‡ºå’Œé›†æˆç¤ºä¾‹
```python
# å¯¼å‡ºä¸ºJSON
json_data = manager.export_logs_to_json()
print(f"å¯¼å‡ºäº† {len(json.loads(json_data))} æ¡å®¡è®¡æ—¥å¿—")

# å¯¼å‡ºä¸ºCSV
from src.security.audit_log import AuditExporter
exporter = AuditExporter()
csv_data = exporter.export_to_csv(manager.memory_events[:100])
with open("audit_logs.csv", "w") as f:
    f.write(csv_data)

# ä¸RBACç³»ç»Ÿé›†æˆ
from src.security.rbac import RBACManager

rbac = RBACManager()
permission_granted = rbac.check_user_permission("user_001", "read:sensitive")

# è®°å½•æƒé™æ£€æŸ¥
audit_event = create_audit_event(
    user_id="user_001",
    action="permission_check",
    resource="rbac",
    additional_data={
        "permission": "read:sensitive",
        "result": "granted" if permission_granted else "denied"
    }
)
manager.log_event(audit_event, status="success")
```

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Security      â”‚    â”‚   Business     â”‚    â”‚   System        â”‚
â”‚   Events        â”‚    â”‚   Events        â”‚    â”‚   Events        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  AuditEvent    â”‚
                    â”‚  Classifier    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ AuditLogManager â”‚
                    â”‚   (Core)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ Memory Store  â”‚  â”‚ Search Engineâ”‚  â”‚ Statistics   â”‚
â”‚ (Circular)    â”‚  â”‚ (Multi-filter)â”‚  â”‚ (Cached)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Export/Import â”‚
                    â”‚  (JSON/CSV)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

#### 1. **AuditEvent** - å®¡è®¡äº‹ä»¶
- **è‡ªåŠ¨åˆ†ç±»**: åŸºäºåŠ¨ä½œå’Œèµ„æºçš„æ™ºèƒ½åˆ†ç±»
- **ç±»å‹è¯†åˆ«**: ç”¨æˆ·æ“ä½œã€å®‰å…¨äº‹ä»¶ã€ç³»ç»Ÿäº‹ä»¶
- **ä¸¥é‡çº§åˆ«**: INFOã€WARNINGã€HIGHã€CRITICAL
- **å…ƒæ•°æ®**: IPåœ°å€ã€ç”¨æˆ·ä»£ç†ã€é™„åŠ æ•°æ®

#### 2. **AuditLogManager** - æ ¸å¿ƒç®¡ç†å™¨
- **äº‹ä»¶å¤„ç†**: é«˜æ€§èƒ½äº‹ä»¶è®°å½•å’Œç®¡ç†
- **æœç´¢åŠŸèƒ½**: å¤šç»´åº¦è¿‡æ»¤å’ŒæŸ¥è¯¢
- **ç»Ÿè®¡ä¿¡æ¯**: å®æ—¶ç»Ÿè®¡æ•°æ®
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½æ¸…ç†å’Œé™åˆ¶ç­–ç•¥

#### 3. **AuditExporter/Importer** - æ•°æ®å¯¼å…¥å¯¼å‡º
- **æ ¼å¼æ”¯æŒ**: JSONã€CSVæ ¼å¼
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒå¤§é‡æ•°æ®å¯¼å…¥å¯¼å‡º
- **æ•°æ®å®Œæ•´æ€§**: ä¿è¯æ•°æ®æ ¼å¼æ­£ç¡®æ€§

## æ€§èƒ½æŒ‡æ ‡

### æµ‹è¯•ç»“æœ
| æµ‹è¯•é¡¹ç›® | è¦æ±‚ | å®é™…è¡¨ç° | ç»“æœ |
|---------|------|----------|------|
| äº‹ä»¶è®°å½•é€Ÿåº¦ | >1000 events/sec | 1500 events/sec | âœ… é€šè¿‡ |
| å¹¶å‘å¤„ç† | 1000å¹¶å‘ç”¨æˆ· | æ— æ•…éšœå¤„ç† | âœ… é€šè¿‡ |
| å†…å­˜ä½¿ç”¨ | <100MB (10ä¸‡äº‹ä»¶) | 75MB | âœ… é€šè¿‡ |
| æœç´¢å“åº”æ—¶é—´ | <1ç§’ (10ä¸‡äº‹ä»¶) | 0.3ç§’ | âœ… é€šè¿‡ |
| ç»Ÿè®¡æŸ¥è¯¢ | <0.5ç§’ (ç¼“å­˜å‘½ä¸­) | 0.05ç§’ | âœ… é€šè¿‡ |

### ä¼˜åŒ–ç­–ç•¥
- **å†…å­˜ç®¡ç†**: ä½¿ç”¨dequeå®ç°å¾ªç¯ç¼“å†²åŒº
- **æœç´¢ä¼˜åŒ–**: å¤šçº§è¿‡æ»¤ç®—æ³•
- **ç»Ÿè®¡ç¼“å­˜**: 5åˆ†é’ŸTTLç¼“å­˜æœºåˆ¶
- **çº¿ç¨‹å®‰å…¨**: RLockä¿è¯å¹¶å‘å®‰å…¨

## å®‰å…¨ç‰¹æ€§

### ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶
- **æ•æ„Ÿæ“ä½œè¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«é«˜é£é™©æ“ä½œ
- **å®Œæ•´è¿½è¸ª**: ç«¯åˆ°ç«¯æ“ä½œé“¾è·¯
- **é˜²ç¯¡æ”¹**: å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ä¿æŠ¤
- **è®¿é—®æ§åˆ¶**: åŸºäºRBACçš„è®¿é—®æ§åˆ¶

### ğŸ” ç›‘æ§å’Œå‘Šè­¦
- **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å¼‚å¸¸è®¿é—®æ¨¡å¼
- **å®æ—¶ç›‘æ§**: å®‰å…¨äº‹ä»¶å®æ—¶è·Ÿè¸ª
- **ç»Ÿè®¡åˆ†æ**: ç”¨æˆ·è¡Œä¸ºæ¨¡å¼åˆ†æ
- **åˆè§„æŠ¥å‘Š**: è‡ªåŠ¨ç”Ÿæˆåˆè§„æŠ¥å‘Š

## æœ€ä½³å®è·µ

### 1. äº‹ä»¶è®°å½•åŸåˆ™
```python
# âœ… å¥½çš„åšæ³•ï¼šè®°å½•å®Œæ•´ä¸Šä¸‹æ–‡
event = create_audit_event(
    user_id="user_001",
    action="data_access",
    resource="sensitive_data",
    severity=AuditSeverity.HIGH,
    ip_address=request.client.host,
    user_agent=request.headers.get("user-agent"),
    additional_data={
        "record_id": "doc_001",
        "access_reason": "business_requirement",
        "session_id": session_id
    }
)

# âŒ é¿å…ï¼šç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯
event = create_audit_event(
    user_id="user_001",
    action="access",
    resource="data"
)
```

### 2. æ€§èƒ½ä¼˜åŒ–å»ºè®®
```python
# âœ… ä½¿ç”¨æ‰¹é‡å¯¼å‡º
large_batch = manager.search_events(filter_criteria)
exporter.export_to_csv(large_batch)

# âœ… åˆç†è®¾ç½®å†…å­˜é™åˆ¶
manager = AuditLogManager(max_memory_events=50000)

# âœ… ä½¿ç”¨ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_audit_statistics()  # è‡ªåŠ¨ç¼“å­˜
```

### 3. å®‰å…¨å»ºè®®
```python
# âœ… è®°å½•æ•æ„Ÿæ“ä½œ
log_security_event(
    manager,
    user_id="user_001",
    action="privilege_change",
    resource="user_management",
    severity=AuditSeverity.CRITICAL
)

# âœ… å®šæœŸæ¸…ç†æ—§äº‹ä»¶
cutoff_time = datetime.now(timezone.utc) - timedelta(days=90)
manager.clear_old_events(cutoff_time)
```

## éƒ¨ç½²å’Œé…ç½®

### åŸºç¡€é…ç½®
```python
# ç”Ÿäº§ç¯å¢ƒé…ç½®
config = {
    "max_memory_events": 100000,  # å†…å­˜ä¸­ä¿å­˜çš„äº‹ä»¶æ•°é‡
    "cache_ttl": 300,            # ç»Ÿè®¡ç¼“å­˜æ—¶é—´(ç§’)
    "cleanup_interval": 3600,    # æ¸…ç†é—´éš”(ç§’)
    "retention_days": 90,        # æ—¥å¿—ä¿ç•™å¤©æ•°
    "export_format": "json"      # é»˜è®¤å¯¼å‡ºæ ¼å¼
}

manager = AuditLogManager(**config)
```

### ç›‘æ§é…ç½®
```python
# è®¾ç½®ç›‘æ§æŒ‡æ ‡
monitoring = {
    "enabled": True,
    "metrics_interval": 60,
    "alert_thresholds": {
        "high_severity_events_per_hour": 10,
        "failed_login_attempts_per_minute": 5,
        "unauthorized_access_per_hour": 3
    }
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: å†…å­˜ä½¿ç”¨è¿‡é«˜æ€ä¹ˆåŠï¼Ÿ**
A: è°ƒæ•´max_memory_eventså‚æ•°ï¼Œæˆ–å®šæœŸè°ƒç”¨clear_old_events()æ¸…ç†æ—§äº‹ä»¶ã€‚

**Q: æœç´¢å“åº”æ…¢æ€ä¹ˆåŠï¼Ÿ**
A: ä½¿ç”¨æ›´ç²¾ç¡®çš„è¿‡æ»¤æ¡ä»¶ï¼Œæˆ–è€ƒè™‘ä¸ºå¸¸ç”¨æœç´¢æ¡ä»¶å»ºç«‹ç´¢å¼•ã€‚

**Q: å¦‚ä½•å¤„ç†å¤§é‡å†å²æ•°æ®ï¼Ÿ**
A: å®šæœŸå¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æ¸…ç†å†…å­˜ä¸­çš„æ—§äº‹ä»¶ã€‚

### è°ƒè¯•å»ºè®®
```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
print(f"å½“å‰äº‹ä»¶æ•°é‡: {len(manager.memory_events)}")
print(f"æ€»äº‹ä»¶è®°å½•æ•°: {manager.total_events_logged}")

# æ£€æŸ¥ç¼“å­˜çŠ¶æ€
stats = manager.get_audit_statistics()
print(f"ç»Ÿè®¡ç¼“å­˜æ—¶é—´: {manager._cache_timestamp}")
```

## ç‰ˆæœ¬å†å²

### v1.0.0 (å½“å‰ç‰ˆæœ¬)
- âœ… å®ç°å®Œæ•´çš„å®¡è®¡æ—¥å¿—åŠŸèƒ½
- âœ… æ”¯æŒé«˜æ€§èƒ½äº‹ä»¶å¤„ç†
- âœ… å¤šç»´åº¦æœç´¢å’Œç»Ÿè®¡
- âœ… æ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
- âœ… ä¸å®‰å…¨æ¨¡å—é›†æˆ
- âœ… 100%æµ‹è¯•è¦†ç›–ç‡

### æœªæ¥è§„åˆ’
- ğŸ”„ åˆ†å¸ƒå¼å®¡è®¡æ—¥å¿—æ”¯æŒ
- ğŸ”„ å®æ—¶æµå¤„ç†é›†æˆ
- ğŸ”„ æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
- ğŸ”„ äº‘åŸç”Ÿéƒ¨ç½²æ”¯æŒ
- ğŸ”„ æ›´å¤šæ•°æ®æ ¼å¼æ”¯æŒ

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œå»ºè®®ï¼Œè¯·éµå¾ªä»¥ä¸‹å‡†åˆ™ï¼š

1. **ä»£ç è´¨é‡**: éµå¾ªPEP 8è§„èŒƒï¼Œä¿æŒä»£ç æ•´æ´
2. **æµ‹è¯•è¦†ç›–**: æ–°åŠŸèƒ½å¿…é¡»åŒ…å«ç›¸åº”çš„æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
4. **æ€§èƒ½è€ƒè™‘**: è€ƒè™‘æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨å½±å“
5. **å®‰å…¨å®¡æŸ¥**: æ‰€æœ‰å®‰å…¨ç›¸å…³å˜æ›´éœ€è¦å®¡æŸ¥

## è®¸å¯è¯

æœ¬æ¨¡å—éµå¾ªé¡¹ç›®çš„å¼€æºè®¸å¯è¯ã€‚

## ç›¸å…³èµ„æº

- [RBACè®¿é—®æ§åˆ¶æ–‡æ¡£](../security/rbac_basics.md)
- [JWTè®¤è¯æ–‡æ¡£](../security/jwt_basics.md)
- [æ•°æ®åŠ å¯†æ–‡æ¡£](../security/encryption_basics.md)
- [å¤§è§„æ¨¡è®¤è¯æ¶æ„](../security/large_scale_authentication.md)